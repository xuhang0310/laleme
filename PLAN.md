# Laleme 小程序深度执行方案 - 行为资产化互动系统

## 1. 核心设计理念：行为资产化
借鉴“支付宝蚂蚁森林/养鸡”模式，将用户的工具行为（记录健康数据）转化为情感资产（小狗的成长与互动），通过“记录 -> 奖励 -> 互动 -> 情感维系”的闭环，提升用户粘性和使用乐趣。

## 2. 交互体验升级 (让小狗“活”起来)
在不引入重型 3D 引擎的前提下，通过 CSS 动画和物理反馈赋予小狗生命力。

### 2.1 视觉动效 (Visual)
- **呼吸感 (Idle State)**:
  - 状态：小狗处于静止时。
  - 效果：通过 CSS3 `transform: scale` 和 `translateY` 组合动画，模拟小狗胸腔起伏和身体微微浮动的呼吸节奏。
- **手指跟随 (Eye Tracking)**:
  - 状态：用户手指在屏幕滑动时。
  - 效果：监听 `touchmove` 事件，计算手指相对小狗的位置，让小狗产生微小的位移或旋转（视差效果），仿佛在注视着用户的手指。
- **进食动效 (Eating)**:
  - 状态：投喂狗粮时。
  - 效果：
    1. 抛物线动画：狗粮图标从底部飞入小狗嘴边。
    2. 咀嚼反馈：小狗进行快速的“挤压-回弹”循环动画，模拟咀嚼动作。
    3. 满足表现：冒出爱心气泡，并伴随快乐的跳跃。
- **抚摸反馈 (Petting)**:
  - 状态：用户点击/抚摸小狗时。
  - 效果：小狗瞬间受到挤压变形 (Squash & Stretch)，配合 `uni.vibrateShort()` 触觉反馈，模拟 Q 弹的肉感。
- **情绪状态机 (Emotion)**:
  - **Normal**: 平稳呼吸。
  - **Happy**: 快速跳动 + 撒花特效（喂食/抚摸后）。
  - **Hungry**: 动作迟缓 + 灰度滤镜（长时间未互动）。

### 2.2 触觉反馈 (Haptic)
- 利用 `uni.vibrateShort()` 配合点击动画，提供真实的物理触感，强化“抚摸”的真实性。

## 3. 游戏化经济系统 (Game Loop) 2.0

### 3.1 核心公式
**1 次记录 + 1 次签到 ≈ 小狗 1 天的口粮**
(1 Record + 1 Check-in ≈ 1 Day of Life)

### 3.2 数值设定 (The Math)

#### **A. 消耗侧 (Burn Rate)**
*   **基础消耗**: **48g / 天** (约 50g)。
*   **衰减机制**: 饱食度上限 100，每小时自然衰减 **2点**。
    *   *这意味着小狗满腹状态下，可以坚持 50小时 (约2天) 不吃东西才会在物理意义上"饿死"。*
*   **换算比例**: **1g 狗粮 = 1点 饱食度**。

#### **B. 供给侧 (Income) - 修正版 v2.1**
*   **每日签到**: **+10g**
*   **记录便便 (收益递减)**:
    *   **第 1 次**: **+40g** (保命粮，确保生存)
    *   **第 2 次**: **+10g** (额外奖励)
    *   **第 3 次**: **+5g** (鼓励金)
    *   *每日上限*: 65g (含签到)。**盈余控制在 +17g/天**，约需3天满勤可积攒1天“假期”。
*   **完美奖励**: **+10g** (额外，不计入递减限制)

### 3.3 状态临界点 (Thresholds)
*   **开心 (Happy)**: 饱食度 **30 ~ 100**
    *   表现：正常呼吸，点击有反馈。
*   **饥饿 (Hungry)**: 饱食度 **0 < x <= 30**
    *   **触发时间**: 距离上次喂饱约 **35小时** 后。
    *   表现：肚子咕咕叫图标，动作迟缓，**无法通过抚摸增加亲密度**。
*   **极饿 (Starving)**: 饱食度 **0**
    *   **触发时间**: 距离上次喂饱约 **50小时** 后。
    *   表现：趴在地上不动，UI 变灰，除喂食外无法进行任何互动。

### 3.4 经济循环与回收 (Sinks)
为了防止长期用户积累过多狗粮导致货币贬值：
1.  **仓储上限 (Wallet Cap)**:
    *   **上限**: **300g** (约1周存量)。
    *   **机制**: 达到上限后无法领取新狗粮，强制用户进行喂食/互动消费。
2.  **爱心转化 (Over-feeding)**:
    *   当饱食度 = 100 时，继续喂食将触发“宠溺”机制。
    *   **消耗 20g 狗粮 -> 增加 5点 亲密度 (XP)**。
    *   *设计目的*: 为“富裕”用户提供消耗出口，加速等级成长。
2.  **互动消耗**:
    *   陪玩/聊天: **-5g / 次** (每次回复消耗少量体能)。

### 3.5 成长体系 (Progression)
- **亲密度等级**: 累计亲密度升级。
- **解锁内容**:
  - Lv.1 -> Lv.2: 解锁“小狗墨镜”皮肤。
  - Lv.2 -> Lv.3: 解锁“AI 智能对话”功能（小狗能根据你的健康状况给建议）。

### 3.6 饥饿与状态机制 (Hunger Mechanics)
*(Merged into 3.3)*

## 4. 质量保证与开发工具 (QA & DevTools)

为了确保长周期养成逻辑的健壮性，开发环境需内置调试工具。

### 4.1 调试面板 (God Mode)
*   **环境限制**: 仅在 `process.env.NODE_ENV === 'development'` 下显示。
*   **功能**:
    *   **时间机器**: 模拟“快进 1小时 / 1天”，验证饥饿衰减。
    *   **状态编辑**: 一键设置 饱食度=0 (验证极饿交互) 或 100 (验证满腹逻辑)。
    *   **资产注入**: 一键获得 500g 狗粮 (验证仓储上限)。

### 4.2 边界交互定义 (Edge Cases)
*   **收益递减**: 第 4 次记录时，弹出 Toast: "今天奖励已领完，明天继续哦！" (非静默失败)。
*   **仓储溢出**: 狗粮 > 300g 时，弹出 Modal: "粮仓已满，快给小狗喂食吧！" (阻止领取)。
*   **极饿状态**: 点击小狗时不播放动画，仅弹出气泡: "饿得动不了了..."。

## 5. 互动系统详解 (Chat System) - 页面核心功能规划

Chat 页面不再仅仅是一个聊天窗口，而是一个“互动庄园”。三个核心按钮将行为与数据紧密联动。

### 5.1 领狗粮 (Task Center)
**入口**：底部左侧按钮
**交互逻辑**：
1.  **点击触发**：从底部滑出半屏弹窗 (ActionSheet 风格)。
2.  **内容展示**：
    *   **今日待领取 (Daily Yield)**：显示今日通过记录和签到累积产生的狗粮总量。
        *   *数据源示例*: `{"food":55, "dailyRecordCount":4, "lastRecordDate":"2026/2/11"}`
        *   此处的 `food: 55` 代表今日产出且**尚未领取**的狗粮。
    *   **仓库状态 (Storage)**：显示 `当前余额 / 最大持仓` (e.g., 120g / 300g)。
    *   **任务状态**：显示今日任务完成进度（如：签到 已完成、记录 4次）。
3.  **领取操作**：
    *   点击“**全部领取**”按钮。
    *   **校验**：
        *   若 `当前余额 + 待领取量 > 最大持仓 (300g)`，提示“粮仓已满，请先喂食消耗”，或仅领取至满仓。
    *   **数据处理 (关键)**：
        *   **余额增加**：`UserStore.food += 待领取量`。
        *   **数据作废/重置**：领取成功后，必须将今日产出数据中的 `food` 字段重置为 0，防止重复领取。
            *   *更新后示例*: `{"food":0, "dailyRecordCount":4, "lastRecordDate":"2026/2/11"}`

### 5.2 喂食 (Feed Interaction)
**入口**：底部中间大按钮 (Main Action)
**交互逻辑**：
1.  **前置校验**：检查本地存储中的狗粮余额。
2.  **分支处理**：
    *   **余额充足 (>= 20g)**：
        *   **扣除资源**：余额 -20g。
        *   **播放动画**：
            1.  生成一个狗粮 Icon，沿贝塞尔曲线从按钮位置飞向小狗嘴边。
            2.  小狗触发 `Eating` 状态（咀嚼动画）。
            3.  头顶冒出爱心气泡，亲密度进度条上涨。
        *   **震动反馈**：`uni.vibrateShort()`。
    *   **余额不足 (< 20g)**：
        *   **小狗反馈**：触发 `Sad` 表情（垂头丧气/摇尾巴停止）。
        *   **系统提示**：弹出模态框“粮仓空了！快去完成任务赚狗粮吧~”，引导点击“领狗粮”。

### 5.3 聊天 (Chat Mode)
**入口**：底部右侧按钮
**交互逻辑**：
1.  **模式切换**：
    *   点击后，底部操作栏下沉消失。
    *   页面背景保持不变（或轻微虚化）。
    *   从底部升起一个全屏/半屏的聊天界面层 (Chat Overlay)。
2.  **功能定义**：
    *   **基础对话**：用户输入文字/表情，小狗基于关键词库回复（如输入“便秘”，回复“多喝水哦”）。
    *   **健康关怀 (Context Aware)**：
        *   系统检测到用户最近 3 天未记录 -> 主动询问“主人这两天身体还好吗？”
        *   系统检测到连续记录“腹泻” -> 主动推送“要注意饮食卫生呀，需要我帮你记一下吃了什么吗？”
3.  **退出**：点击顶部收起按钮，恢复到“庄园模式”。

## 6. 技术执行架构 (Technical Implementation)

### 6.1 数据模型 (Data Schema)
采用本地存储 (`uni.setStorage`) 配合 **Pinia** 进行状态管理。

```javascript
// 核心状态管理 (Store)
// 使用 Pinia + pinia-plugin-persistedstate
interface PetState {
  // 基础属性
  name: string;
  level: number;      // 等级
  exp: number;        // 当前经验/亲密度
  
  // 状态属性 (0-100)
  hunger: number;     // 饥饿度 (随时间衰减)
  happiness: number;  // 快乐值 (随时间衰减)
  
  // 系统属性
  lastLoginDate: string; // 签到判断
  lastInteraction: number; // 上次互动时间戳 (防作弊基准)
}

interface UserState {
  food: number;       // 剩余狗粮 (g) - 仓库余额
  dailyRecordCount: number; // 今日记录次数
  lastRecordDate: string;   // 记录日期重置依据
  dailyProduction: number;  // [新增] 今日待领取狗粮 (对应示例中的 food: 55)
}
```

### 6.2 核心模块开发规划

#### 阶段一：基础架构 (新增)
- [ ] **环境搭建**: 安装 `pinia` 和 `pinia-plugin-persistedstate`。
- [ ] **Store 拆分**: 实现 `usePetStore` 和 `useUserStore`。
- [ ] **DevTools**: 开发侧边悬浮调试球。

#### 阶段二：建立账本 (核心业务)
- [ ] **领狗粮功能**: 实现任务弹窗 UI 及“签到/跳转”逻辑。
- [ ] **喂食闭环**: 连通“喂食”按钮 -> 扣除狗粮 -> 播放抛物线动画 -> 更新 UI。
- [ ] **防刷逻辑**: 实现“收益递减”和“仓储上限”判断。

#### 阶段三：视觉与交互 (UI/UX)
- [ ] **资产补全**: 替换 `puppy_hugry` 为正确的 `puppy_hungry`，补充 Starving/Happy 状态图。
- [ ] **聊天界面**: 开发覆盖式聊天窗口 UI。


## 7. 未来扩展 (Future)
- **云端同步**: 接入 uniCloud，防止数据丢失。
- **AI 对话**: 接入大模型，让小狗根据用户的排便历史，给出专业的健康建议。
